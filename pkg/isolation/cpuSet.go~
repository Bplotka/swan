package isolation

import "os/exec"
import "io/ioutil"
import "strconv"


type CpuSetShares struct {
 cgroupName string
 cpuSetShares string

}

func NewCpuSetShares(nameOfTheCgroup string, cpuSetShares string ) *CpuSetShares{
	return &CpuSetShares{cgroupName: nameOfTheCgroup, cpuSetShares: myCpuSetShares}
}

func (memorySize *MemorySizeShares) Create() error {
	return nil
}

func (memorySize *MemorySizeShares) Delete() error {

	controllerName := "memory"
	cgroupName := "A"
        cmd := exec.Command("sh", "-c", "cgdelete -g "+controllerName+":"+cgroupName)

	err := cmd.Run()
	if err != nil {
		return err
	}

	return nil
}


func (memorySize *MemorySizeShares) Isolate(PID int) error {

     	// 1.a Create memory size cgroup
	controllerName := "memory"
	cgroupName := "A"


        cmd = exec.Command("sh", "-c", "cgcreate -g memory:"+cgroupName)

	err = cmd.Run()
	if err != nil {
		return err
	}

     	// 1.b Set memory size cgroup shares

	memoryShares := "512M"

        cmd = exec.Command("sh", "-c", "cgset -r memory.limit_in_bytes="+memoryShares+" "+cgroupName)

	err = cmd.Run()
	if err != nil {
		return err
	}

     	// 4. Set PID to cgroups

	//Associate task with the cgroup
	//cgclassify seems to exit with error so temporarily using file io

	controllerName = "memory"

        strPID :=strconv.Itoa(PID)
	d := []byte(strPID)
	err3 := ioutil.WriteFile("/sys/fs/cgroup/"+controllerName+"/"+cgroupName+"/tasks", d, 0644)

	if err3 != nil {
		panic(err3.Error())
	}




//        cmd = exec.Command("sh", "-c", "cgclassify -g cpuset:A " + string(PID))
//
//	err = cmd.Run()
//	if err != nil {
//		panic("Cgclassify failed: " + err.Error())
//	}


	return nil
}
